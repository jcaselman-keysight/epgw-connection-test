name: Connection Test

on:
  workflow_dispatch:
    inputs:
      RDPHOSTNAME:
        description: 'RDP Hostname/IP'
        required: true
        default: '192.168.0.1'
      RDPPORT:
        description: 'RDP Port'
        required: true
        default: '3389'
      RDPUSERNAME:
        description: 'RDP Username'
        required: true
        default: 'Administrator'


jobs:
  test-connection:
    runs-on: ubuntu-latest
    container: 
      image: quay.io/eggplantsoftware/fusion-engine-ubi8:23.5.102
      options: --user root
    environment: default
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2
      - name: Run connection test
        env:
          RDPHOSTNAME: ${{ github.event.inputs.RDPHOSTNAME }}
          RDPPORT: ${{ github.event.inputs.RDPPORT }}
          RDPUSERNAME: ${{ github.event.inputs.RDPUSERNAME }}
          RDPPASSWORD: ${{ secrets.RDPPASSWORD }}
          EPF_LICENSE_KEY: ${{ secrets.EPF_LICENSE_KEY }}
        run: |
              export HOME=/root # epgw does not like default github $HOME
              cp -rv /home/eggplant/GNUstep $HOME/
              runscript -LicenseKey "$EPF_LICENSE_KEY"
              mkdir -p ConnectionTest.suite/Scripts
              echo "CaptureScreen Name: \"$(pwd)/ConnectionTestScreenshot.png\"" > ConnectionTest.suite/Scripts/ConnectionTest.script
              runscript -type RDP -host $RDPHOSTNAME -port $RDPPORT -username $RDPUSERNAME -password $RDPPASSWORD ConnectionTest.suite/Scripts/ConnectionTest.script
      - name: Upload Connection Test Screenshot Artifact
        uses: actions/upload-artifact@v4
        with:
            name: Connection Test Screenshot
            path: ./ConnectionTestScreenshot.png